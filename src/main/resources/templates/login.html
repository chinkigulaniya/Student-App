<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Login</title>

    <!-- Font Awesome for Eye Icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>

        /* --- GLOBAL PAGE FADE TRANSITION --- */
        body {
            opacity: 0;
            animation: fadeInPage 1.2s forwards;
        }
        @keyframes fadeInPage { from { opacity: 0; } to { opacity: 1; } }

        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(to bottom right, #8ec5fc, #e0c3fc);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        /* --- ERROR POPUP --- */
        .error-popup {
            position: absolute;
            top: 20px;
            background: #ff4d4d;
            padding: 12px 20px;
            color: white;
            border-radius: 10px;
            font-weight: 600;
            animation: slideDown 0.6s ease-out, shake 0.5s ease-in-out;
            display: none;
            z-index: 10;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translate(-20px); }
            to { opacity: 1; transform: translate(0); }
        }

        @keyframes shake {
            0% { transform: translate(0); }
            20% { transform: translate(-8px); }
            40% { transform: translate(8px); }
            60% { transform: translate(-6px); }
            80% { transform: translate(6px); }
            100% { transform: translate(0); }
        }

        /* FLOATING PARTICLES */
        .particle {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.65);
            animation: particleFloat 8s infinite ease-in-out;
        }
        @keyframes particleFloat {
            0% { transform: translate(0); opacity: 1; }
            50% { transform: translate(-40px); opacity: 0.6; }
            100% { transform: translate(0); opacity: 1; }
        }

        .p1 { width: 12px; height: 12px; top: 20%; left: 10%; animation-delay: 0s; }
        .p2 { width: 18px; height: 18px; top: 40%; right: 18%; animation-delay: 2s; }
        .p3 { width: 14px; height: 14px; bottom: 25%; left: 22%; animation-delay: 1s; }
        .p4 { width: 22px; height: 22px; bottom: 10%; right: 10%; animation-delay: 3s; }

        /* BACKGROUND SHAPES */
        .shape {
            position: absolute;
            border-radius: 30px;
            background: rgba(255, 255, 255, 0.4);
            filter: blur(20px);
            animation: float 5s ease-in-out infinite;
        }

        .shape1 { width: 350px; height: 300px; top: 10%; left: -5%; background: #b9d8ff; }
        .shape2 { width: 500px; height: 350px; bottom: -5%; right: -10%; background: #d8c8ff; animation-delay: 2s; }

        @keyframes float {
            0% { transform: translate(0); }
            50% { transform: translate(-20px); }
            100% { transform: translate(0); }
        }

        /* LOGIN CARD */
        .login-card {
            width: 420px;
            padding: 40px;
            background: rgba(255, 255, 255, 0.28);
            border-radius: 25px;
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            animation: fadeInBox 1s ease-out;
            z-index: 5;
            text-align: center;
        }

        @keyframes fadeInBox {
            from { opacity: 0; transform: translate(-20px); }
            to { opacity: 1; transform: translate(0); }
        }

        .avatar-wrap { width: 140px; height: 140px; margin: 0 auto 20px auto; }
        svg { width: 100%; height: 100%; }

        .eye { transform-origin: center center; animation: blink 4s infinite; }
        @keyframes blink {
            0%,10%,50%,100% { transform: scaleY(1); }
            11%,13% { transform: scaleY(0.05); }
        }

        .hand-left, .hand-right { transform-origin: center; animation: cover 4s infinite ease-in-out; }
        .hand-right { animation-delay: 0.1s; }

        @keyframes cover {
            0% { transform: translate(35%); }
            20% { transform: translate(0); }
            40% { transform: translate(-10%); }
            60% { transform: translate(-10%); }
            80% { transform: translate(0); }
            100% { transform: translate(35%); }
        }

        /* üîµ Title Purple */
        .title-bar {
            background: purple; /* solid purple as requested */
            padding: 12px;
            color: white;
            border-radius: 15px;
            margin-bottom: 25px;
            font-size: 22px;
            font-weight: 600;
        }

        /* INPUTS */
        .input-box { position: relative; width: 100%; }
        .input-box input {
            width: 100%;
            padding: 14px 50px 4px 14px;
            margin-bottom: 20px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
            overflow: hidden;
            box-sizing: border-box;
        }

        /* üëÅ EYE ICON FIXED */
        .eye-icon {
            position: absolute;
            top: 40%;
            right: 14px;
            transform: translateY(-50%);
            cursor: pointer;
            font-size: 20px;
            color: #333;
        }

        /* BUTTON */
        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(to right, #0066ff, #36c8ff);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
        }

        /* Forgot Password INSIDE card */
        .forgot {
            text-align: right;
            margin-top: -10px;
            margin-bottom: 15px;
        }
        .forgot a {
            font-size: 14px;
            color: #005eff;
            text-decoration: none;
        }

        .closeX {
            position: absolute;
            top: 10px;
            right: 12px;
            font-size: 22px;
            cursor: pointer;
            color: #333;
        }

        /* üîµ OTP POPUP */
        .otp-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.55);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }
        .otp-box {
            background: white;
            width: 300px;
            padding: 25px;
            border-radius: 18px;
            text-align: center;
            animation: popupAnim 0.3s ease-out;
            position: relative;
        }
        @keyframes popupAnim {
            from { transform: scale(0.7); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .otp-box input {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #aaa;
            margin-top: 10px;
            margin-bottom: 15px;
        }
        .otp-box button {
            padding: 12px;
            width: 100%;
            background: purple;
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }

    </style>
</head>

<body>

<!-- üî¥ ERROR POPUP -->
<div class="error-popup" th:if="${param.error}">
    Invalid Username or User ID ‚ùå
</div>

<!-- Floating Particles -->
<div class="particle p1"></div>
<div class="particle p2"></div>
<div class="particle p3"></div>
<div class="particle p4"></div>

<!-- Background Shapes -->
<div class="shape shape1"></div>
<div class="shape shape2"></div>

<!-- Login Card -->
<div class="login-card">

    <div class="avatar-wrap">
        <svg viewBox="0 0 200 200">
            <circle cx="100" cy="80" r="58" fill="#dff3fb" stroke="#89c2d8" stroke-width="3"/>
            <ellipse class="eye" cx="78" cy="80" rx="6" ry="6" fill="#1f2a3a"/>
            <ellipse class="eye" cx="122" cy="80" rx="6" ry="6" fill="#1f2a3a"/>
            <path class="hand-left" d="M40 120 h40 v20 h-40 z" fill="#c7ebf7" stroke="#7fb7c8" stroke-width="2"/>
            <path class="hand-right" d="M120 120 h40 v20 h-40 z" fill="#c7ebf7" stroke="#7fb7c8" stroke-width="2"/>
        </svg>
    </div>

    <div class="title-bar">Student App Login</div>

    <form th:action="@{/login}" method="post">

        <div class="input-box">
            <input type="text" name="username" placeholder="Enter Username" required>
        </div>

        <div class="input-box">
            <input type="password" id="id" name="id" placeholder="Enter User ID" required>
            <span class="eye-icon" onclick="togglePass()">
                <i id="eyeIcon" class="fa-solid fa-eye"></i>
            </span>
        </div>

        <!-- Forgot User ID -->
        <div class="forgot">
            <a href="#">Forgot User ID?</a>
        </div>

        <!-- üîµ POPUP 1: Enter Email -->
        <div id="popupEmail" class="otp-popup">
            <span class="closeX" onclick="closePopup('popupEmail')">‚ùå</span>
            <div class="otp-box">
                <h3>Forgot User ID?</h3>
                <p>Enter your email to get OTP</p>
                <input type="email" id="emailInput" placeholder="Enter Email">
                <button type="button" onclick="sendOtpFromServer()">Get OTP</button>
            </div>
        </div>

        <!-- üîµ POPUP 2: Enter OTP -->
        <div id="popupOtp" class="otp-popup">
            <span class="closeX" onclick="closePopup('popupOtp')">‚ùå</span>
            <div class="otp-box">
                <h3>Enter OTP</h3>
                <p>OTP has been sent to your email</p>
                <input type="text" id="otpInput" maxlength="6" placeholder="Enter OTP">
                <button type="button" onclick="verifyOtp()">Verify OTP</button>
            </div>
        </div>

        <!-- Error Msg -->
        <div id="errorMsg"
             style="display:none; position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
             background:#ff4d4d; color:white; padding:10px 20px; border-radius:6px;
             font-weight:bold; box-shadow:0 3px 10px rgba(0,0,0,0.3); z-index:9999;">
        </div>

        <!-- üîµ POPUP 3: Show Credentials -->
        <div id="popupCreds" class="otp-popup">
            <span class="closeX" onclick="closePopup('popupCreds')">‚ùå</span>
            <div class="otp-box">
                <h3>Your Credentials</h3>
                <p><b>Username:</b> <span id="showUser"></span></p>
                <p><b>UserID:</b> <span id="showID"></span></p>
                <button onclick="closePopup('popupCreds')">OK</button>
            </div>
        </div>

        <button type="submit">Login</button>
    </form>

</div>

<script>
    function togglePass() {
        let pass = document.getElementById("id");
        let icon = document.getElementById("eyeIcon");

        if (pass.type === "password") {
            pass.type = "text";
            icon.classList.remove("fa-eye-slash");
            icon.classList.add("fa-eye");
        } else {
            pass.type = "password";
            icon.classList.remove("fa-eye");
            icon.classList.add("fa-eye-slash");
        }
    }

    const popup = document.querySelector(".error-popup");
    if (popup) popup.style.display = "block";

    document.addEventListener("DOMContentLoaded", function () {
        const forgotLink = document.querySelector(".forgot a");
        if (forgotLink) {
            forgotLink.addEventListener("click", function (e) {
                e.preventDefault();
                document.getElementById("popupEmail").style.display = "flex";
            });
        }
    });

    function closePopup(id) {
        document.getElementById(id).style.display = "none";
    }

    function sendOtpFromServer() {
        let email = document.getElementById("emailInput").value.trim();
        if(email === ""){
            showError("Please enter your email!");
            return;
        }

        let emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        if(!emailPattern.test(email)){
            showError("Invalid email address!");
            return;
        }

        fetch("/send-otp?email=" + encodeURIComponent(email), { method: "POST" })
        .then(res => res.json())
        .then(data => {
            if(!data.success){
                showError(data.msg);
                return;
            }
            closePopup("popupEmail");
            document.getElementById("popupOtp").style.display = "flex";
        })
        .catch(err => showError("Server error! OTP not sent."));
    }

    function verifyOtp() {
        let otp = document.getElementById("otpInput").value;

        fetch("/verify-otp?otp=" + encodeURIComponent(otp), { method: "POST" })
        .then(res => res.json())
        .then(data => {
            if(!data.valid){
                alert(data.msg || "Invalid OTP");
                return;
            }
            document.getElementById("showUser").innerText = data.username;
            document.getElementById("showID").innerText = data.userId;

            closePopup("popupOtp");
            document.getElementById("popupCreds").style.display = "flex";
        });
    }

    function showError(msg){
        let e = document.getElementById("errorMsg");
        e.innerText = msg;
        e.style.display = "block";
        setTimeout(()=>{ e.style.display = "none"; }, 2500);
    }

</script>

</body>
</html>